<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tom Triage Testing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-info { @apply text-blue-600; }
        .log-error { @apply text-red-600; }
        .log-warning { @apply text-yellow-600; }
        .log-success { @apply text-green-600; }
        .log-container { height: 400px; overflow-y: auto; }
        .result-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🤖 Tom Triage Testing Dashboard</h1>
            <p class="text-gray-600">Run and analyze LLM triage performance tests</p>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Test Control</h2>
            <div class="flex gap-4 items-center">
                <button id="startBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                    Start Tests
                </button>
                <button id="startDebugBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg transition-colors">
                    Start with Debug
                </button>
                <button id="stopBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50" disabled>
                    Stop Tests
                </button>
                <div id="statusIndicator" class="flex items-center gap-2">
                    <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span id="statusText" class="text-gray-600">Ready</span>
                </div>
            </div>
            
            <!-- Progress Bar (hidden by default) -->
            <div id="progressContainer" class="mt-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <span id="currentLLM" class="text-sm font-medium text-gray-700">Testing...</span>
                    <span id="progressText" class="text-sm text-gray-500">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Test Progress -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Test Progress</h2>
                
                <!-- Overall Progress -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                        <span id="overallProgressText" class="text-sm text-gray-500">0/0 LLMs</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="overallProgressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div id="currentLLMStatus" class="text-sm text-gray-600 mt-2">Ready to start...</div>
                </div>

                <!-- Current Test Progress -->
                <div id="testProgressSection" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Current LLM Tests</span>
                        <span id="testProgressText" class="text-sm text-gray-500">0/0 tests</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="testProgressBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="currentTestDescription" class="text-xs text-gray-500 mt-2">No test running...</div>
                </div>

                <!-- Recent Activity -->
                <div class="mt-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Recent Activity</h3>
                    <div id="recentActivity" class="space-y-1 max-h-32 overflow-y-auto">
                        <div class="text-sm text-gray-500">No activity yet...</div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Quick Stats</h2>
                <div id="quickStats" class="space-y-3">
                    <div class="text-gray-600">No test results available</div>
                </div>
            </div>
        </div>

        <!-- LLM Performance Charts -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">LLM Performance Comparison</h2>
            <div class="mb-4">
                <select id="chartResultSelect" class="border rounded px-3 py-1 mr-4">
                    <option value="">Select Test Result</option>
                </select>
                <div class="mt-2 flex gap-4">
                    <button id="showTimeChart" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                        Response Times
                    </button>
                    <button id="showSuccessChart" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                        Success Rates
                    </button>
                </div>
            </div>
            
            <!-- Response Time Chart -->
            <div id="timeChartContainer" class="relative" style="height: 400px;">
                <canvas id="performanceChart"></canvas>
                <div class="text-sm text-gray-600 mt-2">Showing min/max/median response times for successful requests only</div>
            </div>
            
            <!-- Success Rate Chart -->
            <div id="successChartContainer" class="relative hidden" style="height: 400px;">
                <canvas id="successChart"></canvas>
                <div class="text-sm text-gray-600 mt-2">Success rate percentage for each LLM</div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Test Results</h2>
                <div class="flex gap-4">
                    <select id="llmFilter" class="border rounded px-3 py-1">
                        <option value="">All LLMs</option>
                    </select>
                    <button id="refreshResults" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition-colors">
                        Refresh
                    </button>
                </div>
            </div>

            <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Results will be loaded here -->
            </div>
        </div>

        <!-- Detailed View Modal -->
        <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-7xl w-full max-h-screen overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Detailed Results</h3>
                            <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div id="detailContent">
                            <!-- Detailed content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let testRunning = false;
        let currentResults = [];
        let updateInterval = null;
        let performanceChart = null;
        let successChart = null;

        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const startDebugBtn = document.getElementById('startDebugBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const quickStats = document.getElementById('quickStats');
        const overallProgressBar = document.getElementById('overallProgressBar');
        const overallProgressText = document.getElementById('overallProgressText');
        const currentLLMStatus = document.getElementById('currentLLMStatus');
        const testProgressSection = document.getElementById('testProgressSection');
        const testProgressBar = document.getElementById('testProgressBar');
        const testProgressText = document.getElementById('testProgressText');
        const currentTestDescription = document.getElementById('currentTestDescription');
        const recentActivity = document.getElementById('recentActivity');
        const resultsContainer = document.getElementById('resultsContainer');
        const llmFilter = document.getElementById('llmFilter');
        const refreshResults = document.getElementById('refreshResults');
        const detailModal = document.getElementById('detailModal');
        const closeModal = document.getElementById('closeModal');
        const detailContent = document.getElementById('detailContent');
        const chartResultSelect = document.getElementById('chartResultSelect');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentLLM = document.getElementById('currentLLM');
        const showTimeChart = document.getElementById('showTimeChart');
        const showSuccessChart = document.getElementById('showSuccessChart');
        const timeChartContainer = document.getElementById('timeChartContainer');
        const successChartContainer = document.getElementById('successChartContainer');

        // Event listeners
        startBtn.addEventListener('click', () => startTest(false));
        startDebugBtn.addEventListener('click', () => startTest(true));
        stopBtn.addEventListener('click', stopTest);
        refreshResults.addEventListener('click', loadResults);
        closeModal.addEventListener('click', () => detailModal.classList.add('hidden'));
        llmFilter.addEventListener('change', filterResults);
        chartResultSelect.addEventListener('change', updatePerformanceChart);
        showTimeChart.addEventListener('click', () => switchChart('time'));
        showSuccessChart.addEventListener('click', () => switchChart('success'));

        // Start test function
        async function startTest(debug = false) {
            try {
                const response = await fetch('/api/start_test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ debug })
                });
                
                if (response.ok) {
                    testRunning = true;
                    updateUI();
                    startStatusUpdates();
                } else {
                    const error = await response.json();
                    alert('Error starting test: ' + error.message);
                }
            } catch (error) {
                alert('Error starting test: ' + error.message);
            }
        }

        // Stop test function
        async function stopTest() {
            try {
                const response = await fetch('/api/stop_test', { method: 'POST' });
                if (response.ok) {
                    testRunning = false;
                    updateUI();
                    stopStatusUpdates();
                }
            } catch (error) {
                alert('Error stopping test: ' + error.message);
            }
        }

        // Update UI based on test status
        function updateUI() {
            startBtn.disabled = testRunning;
            startDebugBtn.disabled = testRunning;
            stopBtn.disabled = !testRunning;
            
            if (testRunning) {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
                statusText.textContent = 'Running';
                progressContainer.classList.remove('hidden');
            } else {
                statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
                statusText.textContent = 'Ready';
                progressContainer.classList.add('hidden');
                resetProgress();
            }
        }

        // Reset progress indicators
        function resetProgress() {
            progressBar.style.width = '0%';
            progressText.textContent = '0/0';
            currentLLM.textContent = 'Initializing...';
            
            // Reset detailed progress
            overallProgressBar.style.width = '0%';
            overallProgressText.textContent = '0/0 LLMs';
            currentLLMStatus.textContent = 'Ready to start...';
            testProgressSection.classList.add('hidden');
            testProgressBar.style.width = '0%';
            testProgressText.textContent = '0/0 tests';
            currentTestDescription.textContent = 'No test running...';
            recentActivity.innerHTML = '<div class="text-sm text-gray-500">No activity yet...</div>';
        }

        // Update progress from log message
        function updateProgress(progressMatch) {
            if (!progressMatch) return;
            
            const [, current, total, llmName] = progressMatch;
            const currentNum = parseInt(current);
            const totalNum = parseInt(total);
            const percentage = totalNum > 0 ? (currentNum / totalNum) * 100 : 0;
            
            // Update main progress bar (top control panel)
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${current}/${total}`;
            
            // Update detailed progress bars
            overallProgressBar.classList.remove('animate-pulse'); // Stop pulsing when real progress starts
            overallProgressBar.style.width = `${percentage}%`;
            overallProgressText.textContent = `${current}/${total} LLMs`;
            
            if (llmName === 'Initializing tests') {
                currentLLM.textContent = 'Initializing tests...';
                currentLLMStatus.textContent = 'Initializing tests...';
                testProgressSection.classList.add('hidden');
            } else if (llmName === 'Tests completed') {
                currentLLM.textContent = 'Tests completed!';
                currentLLMStatus.textContent = 'All tests completed!';
                testProgressSection.classList.add('hidden');
            } else {
                currentLLM.textContent = `Testing ${llmName}`;
                currentLLMStatus.textContent = `Starting tests for ${llmName}...`;
                // Test progress section will be shown when first test starts
            }
        }

        // Start status updates
        function startStatusUpdates() {
            updateInterval = setInterval(updateStatus, 2000);
        }

        // Stop status updates
        function stopStatusUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Update test status
        async function updateStatus() {
            try {
                const response = await fetch('/api/test_status');
                const data = await response.json();
                
                if (!data.running && testRunning) {
                    testRunning = false;
                    updateUI();
                    stopStatusUpdates();
                    loadResults(); // Reload results when test completes
                }
                
                // Update progress indicators
                updateProgressIndicators(data.logs);
                
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update progress indicators from logs
        function updateProgressIndicators(logs) {
            if (logs.length === 0) return;
            
            let recentActivities = [];
            
            logs.forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleTimeString();
                
                // Check for LLM progress messages
                const llmProgressMatch = log.message.match(/^PROGRESS: (\d+)\/(\d+) - Testing (.+)$/);
                if (llmProgressMatch) {
                    updateProgress(llmProgressMatch);
                    return;
                }
                
                // Check for test progress messages
                const testProgressMatch = log.message.match(/^TEST_PROGRESS: (\d+)\/(\d+) - (\d+)\/(\d+) - (.+) - (.+)$/);
                if (testProgressMatch) {
                    updateTestProgress(testProgressMatch);
                    return;
                }
                
                // Check for initialization progress messages
                const initProgressMatch = log.message.match(/^INIT_PROGRESS: (.+)$/);
                if (initProgressMatch) {
                    updateInitProgress(initProgressMatch[1]);
                    return;
                }
                
                // Add other important logs to recent activity
                if (log.level === 'SUCCESS' || log.level === 'ERROR' || log.message.includes('Testing LLM')) {
                    recentActivities.push({
                        timestamp: timestamp,
                        level: log.level,
                        message: log.message
                    });
                }
            });
            
            // Update recent activity section
            if (recentActivities.length > 0) {
                const activityHtml = recentActivities.slice(-5).map(activity => {
                    let levelClass = 'text-gray-600';
                    let icon = '•';
                    
                    if (activity.level === 'SUCCESS') {
                        levelClass = 'text-green-600';
                        icon = '✓';
                    } else if (activity.level === 'ERROR') {
                        levelClass = 'text-red-600';
                        icon = '✗';
                    } else if (activity.message.includes('Testing LLM')) {
                        levelClass = 'text-blue-600';
                        icon = '▶';
                    }
                    
                    return `<div class="text-xs ${levelClass} flex items-center gap-2">
                        <span>${icon}</span>
                        <span class="text-gray-400">[${activity.timestamp}]</span>
                        <span class="flex-1 truncate">${activity.message}</span>
                    </div>`;
                }).join('');
                
                recentActivity.innerHTML = activityHtml;
            }
        }

        // Update test progress from log message
        function updateTestProgress(testMatch) {
            if (!testMatch) return;
            
            const [, currentLLM, totalLLMs, currentTest, totalTests, llmName, testDescription] = testMatch;
            
            // Show test progress section
            testProgressSection.classList.remove('hidden');
            
            // Update test progress bar
            const testPercentage = totalTests > 0 ? (parseInt(currentTest) / parseInt(totalTests)) * 100 : 0;
            testProgressBar.style.width = `${testPercentage}%`;
            testProgressText.textContent = `${currentTest}/${totalTests} tests`;
            currentTestDescription.textContent = testDescription;
            
            // Update overall progress status
            currentLLMStatus.textContent = `Testing ${llmName} (${currentTest}/${totalTests} tests)`;
        }

        // Update initialization progress
        function updateInitProgress(message) {
            // Show initialization status in multiple places
            currentLLMStatus.textContent = message;
            currentLLM.textContent = 'Initializing...';
            
            // Show a pulsing animation on the overall progress bar during init
            if (!overallProgressBar.classList.contains('animate-pulse')) {
                overallProgressBar.classList.add('animate-pulse');
                overallProgressBar.style.width = '10%'; // Small progress to show activity
            }
            
            // Add to recent activity with special styling
            const timestamp = new Date().toLocaleTimeString();
            const activityHtml = `<div class="text-xs text-blue-600 flex items-center gap-2">
                <span>⚙️</span>
                <span class="text-gray-400">[${timestamp}]</span>
                <span class="flex-1 truncate">${message}</span>
            </div>`;
            
            // Add to beginning of recent activity
            const currentActivity = recentActivity.innerHTML;
            if (currentActivity.includes('No activity yet')) {
                recentActivity.innerHTML = activityHtml;
            } else {
                recentActivity.innerHTML = activityHtml + currentActivity;
            }
        }

        // Load test results
        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                currentResults = data.results;
                
                displayResults(currentResults);
                updateQuickStats(currentResults);
                updateLLMFilter(currentResults);
                updateChartResultSelect(currentResults);
                
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Display results
        function displayResults(results) {
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="col-span-full text-center text-gray-600">No test results available</div>';
                return;
            }
            
            const html = results.map(result => {
                const data = result.data;
                const triageData = data.triage_performance || {};
                const summary = triageData.test_summary || {};
                
                return `
                    <div class="result-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all" 
                         onclick="showDetails('${result.timestamp}')">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-semibold text-lg">Test Run</h3>
                            <span class="text-sm text-gray-500">${result.timestamp}</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div>LLMs Tested: <span class="font-medium">${summary.total_llms || 0}</span></div>
                            <div>Test Cases: <span class="font-medium">${summary.total_test_cases || 0}</span></div>
                            <div>Total Tests: <span class="font-medium">${summary.total_tests || 0}</span></div>
                        </div>
                        <div class="mt-4">
                            <button class="text-blue-600 hover:text-blue-800 text-sm">View Details →</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.innerHTML = html;
        }

        // Update quick stats
        function updateQuickStats(results) {
            if (results.length === 0) {
                quickStats.innerHTML = '<div class="text-gray-600">No test results available</div>';
                return;
            }
            
            const latest = results[0];
            const triageData = latest.data.triage_performance || {};
            const llmResults = triageData.llm_results || {};
            
            let totalSuccessRate = 0;
            let llmCount = 0;
            let bestLLM = '';
            let bestRate = 0;
            
            Object.entries(llmResults).forEach(([llm, data]) => {
                const rate = data.summary?.success_rate || 0;
                totalSuccessRate += rate;
                llmCount++;
                
                if (rate > bestRate) {
                    bestRate = rate;
                    bestLLM = llm;
                }
            });
            
            const avgSuccessRate = llmCount > 0 ? totalSuccessRate / llmCount : 0;
            
            quickStats.innerHTML = `
                <div class="flex justify-between">
                    <span>Average Success Rate:</span>
                    <span class="font-medium">${(avgSuccessRate * 100).toFixed(1)}%</span>
                </div>
                <div class="flex justify-between">
                    <span>Best Performing LLM:</span>
                    <span class="font-medium">${bestLLM || 'N/A'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Latest Test:</span>
                    <span class="font-medium">${latest.timestamp}</span>
                </div>
            `;
        }

        // Update LLM filter options
        function updateLLMFilter(results) {
            const llms = new Set();
            results.forEach(result => {
                const llmResults = result.data.triage_performance?.llm_results || {};
                Object.keys(llmResults).forEach(llm => llms.add(llm));
            });
            
            const currentValue = llmFilter.value;
            llmFilter.innerHTML = '<option value="">All LLMs</option>';
            
            Array.from(llms).sort().forEach(llm => {
                const option = document.createElement('option');
                option.value = llm;
                option.textContent = llm;
                llmFilter.appendChild(option);
            });
            
            llmFilter.value = currentValue;
        }

        // Filter results by LLM
        function filterResults() {
            const selectedLLM = llmFilter.value;
            if (!selectedLLM) {
                displayResults(currentResults);
                return;
            }
            
            const filtered = currentResults.filter(result => {
                const llmResults = result.data.triage_performance?.llm_results || {};
                return selectedLLM in llmResults;
            });
            
            displayResults(filtered);
        }

        // Update chart result selector
        function updateChartResultSelect(results) {
            const currentValue = chartResultSelect.value;
            chartResultSelect.innerHTML = '<option value="">Select Test Result</option>';
            
            results.forEach(result => {
                const option = document.createElement('option');
                option.value = result.timestamp;
                option.textContent = `Test ${result.timestamp}`;
                chartResultSelect.appendChild(option);
            });
            
            chartResultSelect.value = currentValue;
            
            // If no selection and we have results, select the latest
            if (!currentValue && results.length > 0) {
                chartResultSelect.value = results[0].timestamp;
                switchChart('time'); // Default to time chart
            }
        }

        // Switch between different charts
        function switchChart(chartType) {
            if (chartType === 'time') {
                timeChartContainer.classList.remove('hidden');
                successChartContainer.classList.add('hidden');
                showTimeChart.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                showTimeChart.classList.add('bg-blue-600');
                showSuccessChart.classList.remove('bg-green-600');
                showSuccessChart.classList.add('bg-green-500', 'hover:bg-green-600');
                updatePerformanceChart();
            } else if (chartType === 'success') {
                timeChartContainer.classList.add('hidden');
                successChartContainer.classList.remove('hidden');
                showSuccessChart.classList.remove('bg-green-500', 'hover:bg-green-600');
                showSuccessChart.classList.add('bg-green-600');
                showTimeChart.classList.remove('bg-blue-600');
                showTimeChart.classList.add('bg-blue-500', 'hover:bg-blue-600');
                updateSuccessChart();
            }
        }

        // Update performance chart
        function updatePerformanceChart() {
            const selectedTimestamp = chartResultSelect.value;
            if (!selectedTimestamp) {
                if (performanceChart) {
                    performanceChart.destroy();
                    performanceChart = null;
                }
                return;
            }
            
            const selectedResult = currentResults.find(r => r.timestamp === selectedTimestamp);
            if (!selectedResult) return;
            
            const llmResults = selectedResult.data.triage_performance?.llm_results || {};
            
            // Filter only LLMs with successful tests
            const llmData = Object.entries(llmResults)
                .filter(([llm, data]) => {
                    const summary = data.summary || {};
                    return summary.successful_tests > 0; // Only successful tests
                })
                .map(([llm, data]) => {
                    const summary = data.summary || {};
                    return {
                        llm: llm,
                        min: summary.min_time_ms || 0,
                        max: summary.max_time_ms || 0,
                        median: summary.median_time_ms || 0,
                        successRate: summary.success_rate || 0
                    };
                })
                .sort((a, b) => a.median - b.median); // Sort by median time
            
            if (llmData.length === 0) {
                if (performanceChart) {
                    performanceChart.destroy();
                    performanceChart = null;
                }
                return;
            }
            
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: llmData.map(d => d.llm),
                    datasets: [
                        {
                            label: 'Min Time (ms)',
                            data: llmData.map(d => d.min),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Median Time (ms)',
                            data: llmData.map(d => d.median),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Max Time (ms)',
                            data: llmData.map(d => d.max),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'LLM Response Time Comparison (Successful Requests Only)'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const llmIndex = context.dataIndex;
                                    const successRate = llmData[llmIndex].successRate;
                                    return `Success Rate: ${(successRate * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'LLM Models'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Response Time (milliseconds)'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Update success rate chart
        function updateSuccessChart() {
            const selectedTimestamp = chartResultSelect.value;
            if (!selectedTimestamp) {
                if (successChart) {
                    successChart.destroy();
                    successChart = null;
                }
                return;
            }
            
            const selectedResult = currentResults.find(r => r.timestamp === selectedTimestamp);
            if (!selectedResult) return;
            
            const llmResults = selectedResult.data.triage_performance?.llm_results || {};
            
            // Prepare data for success rate chart
            const llmData = Object.entries(llmResults)
                .map(([llm, data]) => {
                    const summary = data.summary || {};
                    return {
                        llm: llm,
                        successRate: (summary.success_rate || 0) * 100, // Convert to percentage
                        totalTests: summary.total_tests || 0,
                        successfulTests: summary.successful_tests || 0
                    };
                })
                .sort((a, b) => b.successRate - a.successRate); // Sort by success rate descending
            
            if (llmData.length === 0) {
                if (successChart) {
                    successChart.destroy();
                    successChart = null;
                }
                return;
            }
            
            const ctx = document.getElementById('successChart').getContext('2d');
            
            if (successChart) {
                successChart.destroy();
            }
            
            // Color gradient from red (low) to green (high)
            const colors = llmData.map(data => {
                const rate = data.successRate;
                if (rate >= 90) return 'rgba(34, 197, 94, 0.8)'; // Green
                if (rate >= 80) return 'rgba(132, 204, 22, 0.8)'; // Lime
                if (rate >= 70) return 'rgba(234, 179, 8, 0.8)'; // Yellow
                if (rate >= 60) return 'rgba(249, 115, 22, 0.8)'; // Orange
                return 'rgba(239, 68, 68, 0.8)'; // Red
            });

            const borderColors = colors.map(color => color.replace('0.8', '1'));
            
            successChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: llmData.map(d => d.llm),
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: llmData.map(d => d.successRate),
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'LLM Success Rate Comparison'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const llmIndex = context.dataIndex;
                                    const data = llmData[llmIndex];
                                    return `${data.successfulTests}/${data.totalTests} tests passed`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'LLM Models'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            },
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Show detailed results
        async function showDetails(resultId) {
            try {
                const response = await fetch(`/api/results/${resultId}`);
                const result = await response.json();
                
                // Create detailed view
                const triageData = result.data.triage_performance || {};
                const llmResults = triageData.llm_results || {};
                
                let detailHtml = '<div class="space-y-6">';
                
                // Summary section
                detailHtml += '<div><h4 class="font-semibold mb-2">Test Summary</h4>';
                detailHtml += `<div class="bg-gray-50 p-4 rounded">${JSON.stringify(triageData.test_summary, null, 2)}</div></div>`;
                
                // Failed Tests Analysis
                const failedTestsAnalysis = analyzeFailedTests(llmResults);
                if (failedTestsAnalysis.length > 0) {
                    detailHtml += '<div><h4 class="font-semibold mb-2">Failed Tests Analysis</h4>';
                    detailHtml += '<div class="bg-red-50 p-4 rounded">';
                    detailHtml += '<p class="text-sm text-red-600 mb-3">Tests sorted by failure frequency across all LLMs:</p>';
                    detailHtml += '<div class="space-y-2">';
                    
                    failedTestsAnalysis.forEach((failedTest, index) => {
                        const failureRate = ((failedTest.failures / failedTest.total) * 100).toFixed(1);
                        detailHtml += `
                            <div class="border-l-4 border-red-400 pl-3">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">${index + 1}. "${failedTest.prompt}"</div>
                                        <div class="text-xs text-gray-600">Expected: ${failedTest.expected.join(', ')}</div>
                                    </div>
                                    <div class="text-right ml-4">
                                        <div class="text-sm font-medium text-red-600">${failedTest.failures}/${failedTest.total} failed</div>
                                        <div class="text-xs text-red-500">${failureRate}% failure rate</div>
                                    </div>
                                </div>
                                <div class="mt-1 text-xs">
                                    <span class="text-gray-500">Failed on:</span>
                                    <span class="text-red-600">${failedTest.failedLLMs.join(', ')}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    detailHtml += '</div></div></div>';
                }
                
                // LLM Results
                Object.entries(llmResults).forEach(([llm, data]) => {
                    const failures = data.failures || [];
                    detailHtml += `
                        <div>
                            <h4 class="font-semibold mb-2">${llm} Results</h4>
                            <div class="bg-gray-50 p-4 rounded">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    <div>Success Rate: ${((data.summary?.success_rate || 0) * 100).toFixed(1)}%</div>
                                    <div>Min Time: ${data.summary?.min_time_ms || 0}ms</div>
                                    <div>Max Time: ${data.summary?.max_time_ms || 0}ms</div>
                                    <div>Median Time: ${data.summary?.median_time_ms || 0}ms</div>
                                </div>
                                ${failures.length > 0 ? `
                                    <div class="mt-4">
                                        <h5 class="font-medium text-sm mb-2 text-red-600">Failed Tests (${failures.length})</h5>
                                        <div class="space-y-1 max-h-40 overflow-y-auto">
                                            ${failures.map(failure => `
                                                <div class="text-xs bg-red-100 p-2 rounded">
                                                    <div class="font-medium">"${failure.prompt}"</div>
                                                    <div class="text-red-600">Expected: ${failure.expected.join(', ')} | Got: ${failure.received.join(', ')}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                detailHtml += '</div>';
                detailContent.innerHTML = detailHtml;
                detailModal.classList.remove('hidden');
                
            } catch (error) {
                alert('Error loading details: ' + error.message);
            }
        }

        // Analyze failed tests across all LLMs
        function analyzeFailedTests(llmResults) {
            const testFailures = {};
            const totalLLMs = Object.keys(llmResults).length;
            
            // First pass: collect all unique prompts and initialize counters
            Object.entries(llmResults).forEach(([llmName, data]) => {
                const tests = data.tests || [];
                tests.forEach(test => {
                    const key = test.prompt || '';
                    if (!testFailures[key]) {
                        testFailures[key] = {
                            prompt: test.prompt,
                            expected: test.expected || [],
                            failures: 0,
                            total: 0,
                            failedLLMs: []
                        };
                    }
                });
            });
            
            // Second pass: count failures and totals
            Object.entries(llmResults).forEach(([llmName, data]) => {
                const failures = data.failures || [];
                const tests = data.tests || [];
                
                // Count total attempts for each test
                tests.forEach(test => {
                    const key = test.prompt || '';
                    if (testFailures[key]) {
                        testFailures[key].total++;
                    }
                });
                
                // Count failures
                failures.forEach(failure => {
                    const key = failure.prompt;
                    if (testFailures[key]) {
                        testFailures[key].failures++;
                        if (!testFailures[key].failedLLMs.includes(llmName)) {
                            testFailures[key].failedLLMs.push(llmName);
                        }
                    }
                });
            });
            
            // Sort by failure count (descending) then by failure rate
            return Object.values(testFailures)
                .filter(test => test.failures > 0) // Only show tests that actually failed
                .sort((a, b) => {
                    if (b.failures !== a.failures) {
                        return b.failures - a.failures; // Sort by failure count first
                    }
                    return (b.failures / b.total) - (a.failures / a.total); // Then by failure rate
                });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadResults();
        });
    </script>
</body>
</html>